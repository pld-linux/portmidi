--- portmidi/pm_linux/Makefile~	2009-01-20 04:01:54.000000000 +0000
+++ portmidi/pm_linux/Makefile	2010-01-21 18:33:13.000000000 +0000
@@ -21,7 +21,7 @@
 # PMFLAGS = 
 
 # Use this for linux alsa (0.9x) version
-versions = pm_linux/pmlinuxalsa.o
+versions = pm_linux/pmlinuxalsa.lo
 ALSALIB = -lasound
 VFLAGS = -DPMALSA
 
@@ -30,16 +30,19 @@
 # ALSALIB = 
 # VFLAGS = -DPMNULL
 
-pmlib = pm_linux/libportmidi.a
+pmlib = pm_linux/libportmidi.la
 
-ptlib = porttime/libporttime.a
+ptlib = porttime/libporttime.la
 
-CC = gcc $(VFLAGS) $(PMFLAGS) -g -Ipm_common -Iporttime
+CC = gcc
+CFLAGS = $(OPTFLAGS) $(VFLAGS) $(PMFLAGS) -Ipm_common -Iporttime
+libdir = /usr/lib
+includedir = /usr/include
 
-pmobjects = pm_common/pmutil.o $(versions) pm_linux/pmlinux.o  \
-	pm_common/portmidi.o pm_linux/finddefault.o
+pmobjects = pm_common/pmutil.lo $(versions) pm_linux/pmlinux.lo  \
+	pm_common/portmidi.lo pm_linux/finddefault.lo
 
-ptobjects = porttime/porttime.o porttime/ptlinux.o
+ptobjects = porttime/porttime.lo porttime/ptlinux.lo
 
 current: all
 
@@ -47,46 +50,49 @@
 	pm_test/latency pm_test/midithru pm_test/qtest pm_test/mm \
 	pm_java/pmjni/libpmjni.so pm_java/pmdefaults/pmdefaults.jar 
 
-$(pmlib): pm_linux/Makefile $(pmobjects)
-	ar -cr $(pmlib) $(pmobjects)
+$(pmlib): pm_linux/Makefile $(pmobjects) $(ptlib)
+	libtool --tag=CC --mode=link $(CC) -shared -o $(pmlib) $(pmobjects) -rpath $(libdir) $(ptlib) $(ALSALIB)
 
 $(ptlib): pm_linux/Makefile $(ptobjects)
-	ar -cr $(ptlib) $(ptobjects)
+	libtool --tag=CC --mode=link $(CC) -shared -o $(ptlib) $(ptobjects) -rpath $(libdir) -lpthread
 
-pm_linux/pmlinuxalsa.o: pm_linux/Makefile pm_linux/pmlinuxalsa.c pm_linux/pmlinuxalsa.h
-	$(CC) -c pm_linux/pmlinuxalsa.c -o pm_linux/pmlinuxalsa.o
+pm_linux/pmlinuxalsa.lo: pm_linux/Makefile pm_linux/pmlinuxalsa.c pm_linux/pmlinuxalsa.h
+	libtool --mode=compile $(CC) $(CFLAGS) -c pm_linux/pmlinuxalsa.c -o pm_linux/pmlinuxalsa.lo
 
 #---------- test programs ------------
 
 
 
 pm_test/test: pm_linux/Makefile pm_test/test.o $(pmlib) $(ptlib)
-	$(CC) pm_test/test.o -o pm_test/test $(pmlib) $(ptlib) $(ALSALIB)
+	libtool --mode=link $(CC) pm_test/test.o -o pm_test/test $(pmlib) $(ptlib) $(ALSALIB)
 
 pm_test/sysex: pm_linux/Makefile pm_test/sysex.o $(pmlib) $(ptlib)
-	$(CC) pm_test/sysex.o -o pm_test/sysex $(pmlib) $(ptlib) $(ALSALIB)
+	libtool --mode=link $(CC) pm_test/sysex.o -o pm_test/sysex $(pmlib) $(ptlib) $(ALSALIB)
 
 pm_test/midithread: pm_linux/Makefile pm_test/midithread.o $(pmlib) $(ptlib)
-	$(CC) pm_test/midithread.o -o pm_test/midithread \
+	libtool --mode=link $(CC) pm_test/midithread.o -o pm_test/midithread \
         $(pmlib) $(ptlib) $(ALSALIB)
 
 pm_test/latency: pm_linux/Makefile $(ptlib) pm_test/latency.o 
-	$(CC) pm_test/latency.o -o pm_test/latency $(pmlib) $(ptlib) \
+	libtool --mode=link $(CC) pm_test/latency.o -o pm_test/latency $(pmlib) $(ptlib) \
         $(ALSALIB) -lpthread -lm
 
 pm_test/midithru: pm_linux/Makefile $(ptlib) pm_test/midithru.o 
-	$(CC) pm_test/midithru.o -o pm_test/midithru $(pmlib) $(ptlib) \
+	libtool --mode=link $(CC) pm_test/midithru.o -o pm_test/midithru $(pmlib) $(ptlib) \
         $(ALSALIB) -lpthread -lm
 
 pm_test/mm: pm_linux/Makefile $(ptlib) pm_test/mm.o 
-	$(CC) pm_test/mm.o -o pm_test/mm $(pmlib) $(ptlib) \
+	libtool --mode=link $(CC) pm_test/mm.o -o pm_test/mm $(pmlib) $(ptlib) \
         $(ALSALIB) -lpthread -lm
 
-porttime/ptlinux.o: pm_linux/Makefile porttime/ptlinux.c
-	$(CC) -c porttime/ptlinux.c -o porttime/ptlinux.o
+porttime/ptlinux.lo: pm_linux/Makefile porttime/ptlinux.c
+	libtool --mode=compile $(CC) $(CFLAGS) -c porttime/ptlinux.c -o porttime/ptlinux.lo
 
 pm_test/qtest: pm_linux/Makefile pm_test/qtest.o $(pmlib) $(ptlib)
-	$(CC) pm_test/qtest.o -o pm_test/qtest $(pmlib) $(ptlib) $(ALSALIB)
+	libtool --mode=link $(CC) pm_test/qtest.o -o pm_test/qtest $(pmlib) $(ptlib) $(ALSALIB)
+
+%.lo: %.c
+	libtool --mode=compile $(CC) $(CFLAGS) -c $< -o $@
 
 #------------ Java stuff here --------------
 
@@ -151,6 +157,12 @@
 	cp pm_java/pmdefaults.jar /usr/share/java
 	# do not chmod +x here since we are probably root
 	cp pm_java/pmdefaults/pmdefaults /usr/local/bin
+	install -d $(DESTDIR)$(libdir) $(DESTDIR)$(includedir)
+	libtool --mode=install install $(ptlib) $(DESTDIR)$(libdir)
+	libtool --mode=install install $(pmlib) $(DESTDIR)$(libdir)
+	install -m644 porttime/porttime.h $(DESTDIR)$(includedir)
+	install -m644 pm_common/portmidi.h $(DESTDIR)$(includedir)
+	install -m644 pm_common/pmutil.h $(DESTDIR)$(includedir)
 
 clean:
 	rm -f *.o *~ core* */*.o */*.so */*~ */core* pm_test/*/pm_dll.dll 
